<div class="member-list">
  <div class="header">
    <h2>Members</h2>
    <div class="header-buttons">
      <button *ngIf="isAllowed(['admin', 'developer', 'fieldhand'])" mat-raised-button color="primary" (click)="addMember()">
        <mat-icon>add</mat-icon>
        Add Member
      </button>
      <button *ngIf="isAdmin" mat-raised-button color="warn" (click)="removeDuplicateEmails()" matTooltip="Remove members with duplicate email addresses, keeping the oldest">
        <mat-icon>content_copy</mat-icon>
        Remove Duplicates
      </button>
      <!-- Move the toggle hidden members button to the top -->
      <button mat-raised-button color="accent" (click)="toggleHiddenMembers()">
        {{ showHiddenMembers ? 'Hide Hidden Members' : 'Show Hidden Members' }}
      </button>
    </div>
  </div>

  <!-- Filter Controls -->
  <div class="filter-container">
    <mat-form-field appearance="outline" class="search-field" floatLabel="always">
      <mat-label>Search members...</mat-label>
      <input matInput [(ngModel)]="searchTerm" (ngModelChange)="onSearchChange()" placeholder="Search by name or email">
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <!-- Column Visibility Menu -->
    <button mat-icon-button [matMenuTriggerFor]="columnMenu" matTooltip="Show/Hide Columns ({{ getVisibleColumnsCount() }} visible)">
      <mat-icon>view_column</mat-icon>
    </button>
    <mat-menu #columnMenu="matMenu" class="column-menu">
      <div class="menu-header">
        <strong>Show/Hide Columns</strong>
        <small *ngIf="hasCustomPreferences()" class="preferences-indicator">â€¢ Customized</small>
      </div>
      <div *ngFor="let column of allColumns" class="column-menu-item">
        <mat-checkbox 
          [checked]="column.visible" 
          [disabled]="column.fixed"
          (change)="toggleColumnVisibility(column.key)"
          class="column-checkbox">
          {{ column.label }}
        </mat-checkbox>
      </div>
      <mat-divider></mat-divider>
      <button mat-menu-item (click)="resetColumns()">
        <mat-icon>refresh</mat-icon>
        <span>Show All Columns</span>
      </button>
      <button mat-menu-item (click)="clearAllPreferences()">
        <mat-icon>clear_all</mat-icon>
        <span>Reset All Preferences</span>
      </button>
    </mat-menu>

    <div class="sort-info">
      <mat-icon>info</mat-icon>
      <span>Click column headers to sort</span>
    </div>
  </div>

  <mat-divider></mat-divider>

  <!-- Progress Bar -->
  <mat-progress-bar *ngIf="loading" mode="indeterminate"></mat-progress-bar>

  <!-- Members Table -->
  <div *ngIf="!loading" class="table-container">
    <table mat-table [dataSource]="pagedMembers" matSort (matSortChange)="sortData($event)" class="members-table">
      
      <!-- Name Column -->
      <ng-container matColumnDef="fullName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header="fullName">Name</th>
        <td mat-cell *matCellDef="let member">
          {{ member.fullName || member.firstName + ' ' + (member.lastName || '') }}
        </td>
      </ng-container>

      <!-- Email Column -->
      <ng-container matColumnDef="Email">
        <th mat-header-cell *matHeaderCellDef mat-sort-header="Email">Email</th>
        <td mat-cell *matCellDef="let member">{{ member.Email }}</td>
      </ng-container>

      <!-- GHIN Column -->
      <ng-container matColumnDef="GHIN">
        <th mat-header-cell *matHeaderCellDef mat-sort-header="GHIN">GHIN</th>
        <td mat-cell *matCellDef="let member">{{ (member.GHIN || member.ghin) || '-' }}</td>
      </ng-container>

      <!-- USGA Index Column -->
      <ng-container matColumnDef="usgaIndex">
        <th mat-header-cell *matHeaderCellDef mat-sort-header="usgaIndex">USGA Index</th>
        <td mat-cell *matCellDef="let member">
          {{ member.usgaIndex !== undefined ? (member.usgaIndex | number:'1.1-1') : '-' }}
        </td>
      </ng-container>

      <!-- Handicap Column -->
      <ng-container matColumnDef="handicap">
        <th mat-header-cell *matHeaderCellDef mat-sort-header="handicap">Handicap</th>
        <td mat-cell *matCellDef="let member">
          {{ member.handicap !== undefined && member.handicap !== null ? (member.handicap | number:'1.0-1') : '-' }}
        </td>
      </ng-container>

      <!-- Last Date Played Column -->
      <ng-container matColumnDef="lastDatePlayed">
        <th mat-header-cell *matHeaderCellDef mat-sort-header="lastDatePlayed">Last Played</th>
        <td mat-cell *matCellDef="let member">
          {{ member.lastDatePlayed ? (member.lastDatePlayed | date:'shortDate') : '-' }}
        </td>
      </ng-container>

      <!-- Hidden Column -->
      <ng-container matColumnDef="hidden">
        <th mat-header-cell *matHeaderCellDef mat-sort-header="hidden">Hidden</th>
        <td mat-cell *matCellDef="let member">
          {{ member.hidden ? 'Yes' : 'No' }}
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let member" class="actions-cell">
          <div class="action-buttons">
            <button *ngIf="isAllowed(['admin', 'developer'])" mat-icon-button color="accent" (click)="editMember((member.id ?? member._id) || '')" matTooltip="Edit Member">
              <mat-icon>edit</mat-icon>
            </button>
            <button *ngIf="isAllowed(['admin'])" mat-icon-button color="warn" (click)="deleteMember((member.id ?? member._id) || '')" matTooltip="Delete Member">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <!-- Table Header and Rows -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="member-row"></tr>
    </table>

    <!-- No Data Message -->
    <div *ngIf="!filteredMembers.length && !loading" class="no-data">
      <mat-icon>person_off</mat-icon>
      <p>{{ searchTerm ? 'No members match your search criteria.' : 'No members found.' }}</p>
      <button *ngIf="searchTerm" mat-button (click)="searchTerm = ''; onSearchChange()">Clear Search</button>
    </div>

    <!-- Pagination -->
    <mat-paginator 
      [length]="filteredMembers.length" 
      [pageSize]="pageSize" 
      [pageSizeOptions]="pageSizeOptions" 
      showFirstLastButtons>
    </mat-paginator>
    </div>
</div>
