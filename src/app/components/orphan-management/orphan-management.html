   
<div class="orphan-management" *ngIf="isAdmin">
  <div class="header">
    <h2>Orphaned Records Management</h2>
    <button mat-raised-button color="primary" (click)="loadReport()" [disabled]="loading">
      <mat-icon>refresh</mat-icon>
      Refresh Report
    </button>
  </div>

  <mat-progress-bar *ngIf="loading" mode="indeterminate"></mat-progress-bar>

  <div *ngIf="report && !loading" class="report-container">
        <!-- Removed Flagged Orphaned Score and HCap Records sections -->
    <!-- Summary Cards -->
    <div class="summary-cards">
      <mat-card class="summary-card">
        <mat-card-header>
          <mat-card-title>Total Orphans</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="stat-number" [ngClass]="{'warning': report.summary.totalOrphans > 0}">
            {{ report.summary.totalOrphans }}
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="summary-card">
        <mat-card-header>
          <mat-card-title>Match Orphans</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="stat-number">{{ report.summary.matchOrphans }}</div>
          <div class="stat-description">Scores with deleted match references</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="summary-card">
        <mat-card-header>
          <mat-card-title>Member Orphans</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="stat-number">{{ report.summary.memberOrphans }}</div>
          <div class="stat-description">Scores with deleted member references</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="summary-card">
        <mat-card-header>
          <mat-card-title>HCap Orphans</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="stat-number">{{ hcapOrphans.length }}</div>
          <div class="stat-description">HCap records without Score or Match</div>
        </mat-card-content>
      </mat-card>
      <mat-card class="summary-card">
        <mat-card-header>
          <mat-card-title>Intentional Orphans</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="stat-number">{{ report.summary.intentionalOrphans }}</div>
          <div class="stat-description">Scores intentionally orphaned (removed from match)</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="summary-card">
        <mat-card-header>
          <mat-card-title>Other Orphans</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="stat-number">
            {{ report.summary.scorecardOrphans + report.summary.userOrphans }}
          </div>
          <div class="stat-description">Scorecard & User orphans</div>
        </mat-card-content>
      </mat-card>
        <!-- HCap Orphans Table -->
        <mat-card class="orphans-card" *ngIf="hcapOrphans.length > 0">
          <mat-card-header>
            <mat-card-title>Orphaned HCap Records</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <table class="orphans-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Date Played</th>
                  <th>Reason</th>
                  <th>ScoreId</th>
                  <th>MatchId</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let orphan of hcapOrphans">
                  <td>{{ orphan.hcap.name }}</td>
                  <td>{{ orphan.hcap.datePlayed | date:'shortDate' }}</td>
                  <td>{{ orphan.reason }}</td>
                  <td>{{ orphan.hcap.scoreId }}</td>
                  <td>{{ orphan.hcap.matchId }}</td>
                  <td>
                    <button mat-icon-button color="warn" (click)="deleteHcapOrphan(orphan.hcap._id || orphan.hcap.id || orphan.hcap.scoreId)" [disabled]="deletingHcapIds.has(orphan.hcap._id || orphan.hcap.id || orphan.hcap.scoreId)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </mat-card-content>
        </mat-card>
    </div>

    <!-- Recommendations -->
    <mat-card class="recommendations-card" *ngIf="report.recommendations.length > 0">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>lightbulb</mat-icon>
          Recommendations
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div *ngFor="let rec of report.recommendations" class="recommendation" [ngClass]="rec.severity">
          <mat-icon [color]="getSeverityColor(rec.severity)">{{ getSeverityIcon(rec.severity) }}</mat-icon>
          <span>{{ rec.message }}</span>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Cleanup Actions removed: backend not implemented -->

    <!-- No Orphans Message -->
    <mat-card class="no-orphans-card" *ngIf="report.summary.totalOrphans === 0">
      <mat-card-content>
        <div class="success-message">
          <mat-icon color="primary">check_circle</mat-icon>
          <h3>No Orphaned Records Found</h3>
          <p>Your database is clean and all references are valid.</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

   <!-- Intentional Orphans Table -->
    <mat-card class="orphans-card" *ngIf="intentionalOrphans.length > 0">
      <mat-card-header>
        <mat-card-title>Intentional Orphaned Scores</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <table class="orphans-table">
          <thead>
            <tr>
              <th>Player</th>
              <th>Date Played</th>
              <th>ScoreId</th>
              <th>Reason</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let orphan of intentionalOrphans">
              <td>{{ orphan.playerName || orphan.memberId || orphan.name }}</td>
              <td>{{ orphan.datePlayed | date:'shortDate' }}</td>
              <td>{{ orphan._id || orphan.id }}</td>
              <td>Intentionally orphaned</td>
              <td>
                <button mat-icon-button color="warn" (click)="deleteIntentionalOrphan(orphan._id || orphan.id)" [disabled]="deletingIntentionalOrphanIds.has(orphan._id || orphan.id)">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </mat-card-content>
    </mat-card>

  <!-- Access Denied -->
  <div *ngIf="!isAdmin" class="access-denied">
    <mat-card>
      <mat-card-content>
        <div class="denied-message">
          <mat-icon color="warn">block</mat-icon>
          <h3>Access Denied</h3>
          <p>You need administrator privileges to access orphan management.</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>