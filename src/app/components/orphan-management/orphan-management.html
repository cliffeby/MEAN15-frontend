<div class="orphan-management" *ngIf="isAdmin">
  <div class="header">
    <h2>Orphaned Records Management</h2>
    <button mat-raised-button color="primary" (click)="loadReport()" [disabled]="loading">
      <mat-icon>refresh</mat-icon>
      Refresh Report
    </button>
  </div>

  <mat-progress-bar *ngIf="loading" mode="indeterminate"></mat-progress-bar>

  <div *ngIf="report && !loading" class="report-container">
    <!-- Summary Cards -->
    <div class="summary-cards">
      <mat-card class="summary-card">
        <mat-card-header>
          <mat-card-title>Total Orphans</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="stat-number" [ngClass]="{'warning': report.summary.totalOrphans > 0}">
            {{ report.summary.totalOrphans }}
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="summary-card">
        <mat-card-header>
          <mat-card-title>Match Orphans</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="stat-number">{{ report.summary.matchOrphans }}</div>
          <div class="stat-description">Scores with deleted match references</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="summary-card">
        <mat-card-header>
          <mat-card-title>Member Orphans</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="stat-number">{{ report.summary.memberOrphans }}</div>
          <div class="stat-description">Scores with deleted member references</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="summary-card">
        <mat-card-header>
          <mat-card-title>Other Orphans</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="stat-number">
            {{ report.summary.scorecardOrphans + report.summary.userOrphans }}
          </div>
          <div class="stat-description">Scorecard & User orphans</div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Recommendations -->
    <mat-card class="recommendations-card" *ngIf="report.recommendations.length > 0">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>lightbulb</mat-icon>
          Recommendations
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div *ngFor="let rec of report.recommendations" class="recommendation" [ngClass]="rec.severity">
          <mat-icon [color]="getSeverityColor(rec.severity)">{{ getSeverityIcon(rec.severity) }}</mat-icon>
          <span>{{ rec.message }}</span>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Cleanup Actions -->
    <mat-card class="actions-card" *ngIf="report.summary.totalOrphans > 0">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>build</mat-icon>
          Cleanup Actions
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="action-description">
          <p>Choose how to handle the {{ report.summary.totalOrphans }} orphaned records:</p>
        </div>
        
        <div class="action-buttons">
          <button mat-raised-button color="primary" 
                  (click)="cleanupOrphans('nullify')" 
                  [disabled]="cleanupLoading">
            <mat-icon>link_off</mat-icon>
            Nullify References
            <span class="action-help">(Recommended - removes broken links)</span>
          </button>

          <button mat-stroked-button color="accent" 
                  (click)="cleanupOrphans('preserve')" 
                  [disabled]="cleanupLoading">
            <mat-icon>archive</mat-icon>
            Preserve for Review
            <span class="action-help">(Keep for manual investigation)</span>
          </button>

          <button mat-raised-button color="warn" 
                  (click)="cleanupOrphans('delete')" 
                  [disabled]="cleanupLoading">
            <mat-icon>delete_forever</mat-icon>
            Delete Orphans
            <span class="action-help">(Permanent removal - use with caution)</span>
          </button>
        </div>

        <mat-progress-bar *ngIf="cleanupLoading" mode="indeterminate" class="cleanup-progress"></mat-progress-bar>
      </mat-card-content>
    </mat-card>

    <!-- No Orphans Message -->
    <mat-card class="no-orphans-card" *ngIf="report.summary.totalOrphans === 0">
      <mat-card-content>
        <div class="success-message">
          <mat-icon color="primary">check_circle</mat-icon>
          <h3>No Orphaned Records Found</h3>
          <p>Your database is clean and all references are valid.</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Access Denied -->
  <div *ngIf="!isAdmin" class="access-denied">
    <mat-card>
      <mat-card-content>
        <div class="denied-message">
          <mat-icon color="warn">block</mat-icon>
          <h3>Access Denied</h3>
          <p>You need administrator privileges to access orphan management.</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>