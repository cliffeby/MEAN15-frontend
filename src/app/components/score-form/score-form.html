<form [formGroup]="scoreForm" (ngSubmit)="submit()" class="score-form">
  <mat-form-field appearance="fill">
    <mat-label>Name</mat-label>
    <input matInput formControlName="name" required placeholder="Enter player name" title="Name" />
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Score</mat-label>
    <input matInput formControlName="score" type="number" required placeholder="Enter score" title="Score" />
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Posted Score</mat-label>
    <input matInput formControlName="postedScore" type="number" required placeholder="Enter posted score" title="Posted Score" />
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Handicap</mat-label>
    <input matInput formControlName="handicap" type="number" required placeholder="Enter handicap" title="Handicap" />
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>USGA Index</mat-label>
    <input matInput formControlName="usgaIndex" type="number" step="0.1" min="-10" max="54" placeholder="Enter USGA Index (e.g. 12.5)" title="USGA Index" />
    <mat-error *ngIf="isUsgaIndexMinError">
      USGA Index cannot be less than -10.0
    </mat-error>
    <mat-error *ngIf="isUsgaIndexMaxError">
      USGA Index cannot be greater than 54.0
    </mat-error>
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>USGA Index for Today's Score</mat-label>
    <input matInput formControlName="usgaIndexForTodaysScore" type="number" step="0.1" min="-10" max="54" placeholder="Enter USGA Index for today (e.g. 12.5)" title="USGA Index for Today" />
    <mat-error *ngIf="isUsgaIndexForTodaysScoreMinError">
      USGA Index cannot be less than -10.0
    </mat-error>
    <mat-error *ngIf="isUsgaIndexForTodaysScoreMaxError">
      USGA Index cannot be greater than 54.0
    </mat-error>
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Scorecard</mat-label>
    <mat-select formControlName="scorecardId" placeholder="Select a scorecard" (selectionChange)="onScorecardChange($event.value)">
      <mat-option value="">None</mat-option>
      @for (scorecard of scorecards$ | async; track scorecard._id) {
        <mat-option [value]="scorecard._id">
          {{ scorecard.name || scorecard.groupName || 'Unnamed Scorecard' }}
          @if (scorecard.rating || scorecard.slope) {
            <span class="scorecard-details">
              @if (scorecard.rating) { <span> - Rating: {{ scorecard.rating }}</span> }
              @if (scorecard.slope) { <span> - Slope: {{ scorecard.slope }}</span> }
            </span>
          }
        </mat-option>
      }
    </mat-select>
    <mat-hint>Select a scorecard to auto-populate course details</mat-hint>
  </mat-form-field>

  <!-- Course Information (Auto-populated from Scorecard) -->
  @if (scoreForm.get('scorecardId')?.value) {
    <div class="course-info">
    <mat-card class="course-details-card">
      <mat-card-header>
        <mat-card-title>Course Information</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="course-detail">
          <strong>Course Name:</strong> 
          <span>{{ scoreForm.get('scName')?.value || 'Not specified' }}</span>
        </div>
        <div class="course-detail">
          <strong>Course Rating:</strong> 
          <span>{{ scoreForm.get('scRating')?.value || 'Not specified' }}</span>
        </div>
        <div class="course-detail">
          <strong>Course Slope:</strong> 
          <span>{{ scoreForm.get('scSlope')?.value || 'Not specified' }}</span>
        </div>
      </mat-card-content>
    </mat-card>
    </div>
  }

  <mat-form-field appearance="fill">
    <mat-label>Date Played</mat-label>
    <input matInput [matDatepicker]="picker" formControlName="datePlayed" placeholder="Select date played" title="Date Played" />
    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
    <mat-datepicker #picker></mat-datepicker>
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Member ID</mat-label>
    <input matInput formControlName="memberId" placeholder="Enter member ID" title="Member ID" />
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Scorecard ID</mat-label>
    <input matInput formControlName="scorecardId" placeholder="Enter scorecard ID" title="Scorecard ID" />
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>User</mat-label>
    <input matInput formControlName="user" required placeholder="Enter user" title="User" />
  </mat-form-field>

  <div class="checkbox-group">
    <mat-checkbox formControlName="wonTwoBall">Won Two Ball</mat-checkbox>
    <mat-checkbox formControlName="wonOneBall">Won One Ball</mat-checkbox>
    <mat-checkbox formControlName="wonIndo">Won Indo</mat-checkbox>
    <mat-checkbox formControlName="isPaired">Is Paired</mat-checkbox>
    <mat-checkbox formControlName="isScored">Is Scored</mat-checkbox>
  </div>

  <div class="array-section">
    <h3>Individual Hole Scores</h3>
    <div formArrayName="scores">
      @for (scoreControl of scoresArray.controls; track $index) {
        <div class="array-item">
          <mat-form-field appearance="fill">
            <mat-label>Hole {{ $index + 1 }}</mat-label>
            <input matInput [formControlName]="$index" type="number" placeholder="Enter score for hole {{ $index + 1 }}" />
          </mat-form-field>
          <button mat-icon-button type="button" color="warn" (click)="removeScore($index)">
            <span>Ã—</span>
          </button>
        </div>
      }
    </div>
    <button mat-button type="button" (click)="addScore()">Add Hole Score</button>
  </div>

  <button mat-raised-button color="primary" type="submit" [disabled]="loading || scoreForm.invalid">
    {{ loading ? 'Saving...' : 'Save Score' }}
  </button>
</form>