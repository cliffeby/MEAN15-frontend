<div class="email-dialog">
  <h2 mat-dialog-title>
    <mat-icon>email</mat-icon>
    <span>{{ isSendToAll ? 'Send Email to All Members' : 'Send Email to Members' }}</span>
  </h2>

  <mat-dialog-content>
    <!-- Recipients Info -->
    <div class="recipients-section">
      <div class="recipients-header">
        <mat-icon>people</mat-icon>
        <span class="recipients-count">
          {{ isSendToAll ? 'All Members' : recipientCount + ' Recipient' + (recipientCount !== 1 ? 's' : '') }}
        </span>
      </div>
      
      <div class="recipients-list" *ngIf="!isSendToAll && recipientCount > 0">
        <mat-chip-listbox>
          <mat-chip *ngFor="let name of displayRecipients">{{ name }}</mat-chip>
          <mat-chip class="more-chip" *ngIf="hasMoreRecipients">
            +{{ additionalRecipients }} more
          </mat-chip>
        </mat-chip-listbox>
      </div>
    </div>

    <!-- Email Form -->
    <div class="email-form">
      <!-- Templates -->
      <div class="templates-section">
        <div class="templates-header">Templates</div>
        <mat-chip-listbox>
          <mat-chip
            *ngFor="let tpl of templates"
            selectable
            [class.selected]="selectedTemplateId() === tpl.id"
            (click)="selectTemplate(tpl.id)">
            {{ tpl.name }}
          </mat-chip>
        </mat-chip-listbox>
        <div *ngIf="currentTemplate?.snippets" class="template-snippets">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Snippets</mat-label>
            <mat-select multiple [value]="selectedSnippet()" (selectionChange)="onSnippetChange($event.value)">
              <mat-option *ngFor="let s of currentTemplate?.snippets" [value]="s.id">{{ s.label }}</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <!-- Preview Panel -->
      <div class="preview-panel" *ngIf="previewMode()">
        <div class="preview-subject">Subject: <strong>{{ subject() }}</strong></div>
        <div class="preview-recipients">Recipients: <span *ngIf="isSendToAll">All Members</span><span *ngIf="!isSendToAll">{{ recipientCount }} recipient{{ recipientCount !== 1 ? 's' : '' }}</span></div>
        <div class="message-preview" [innerHTML]="getPreviewHtml()"></div>
      </div>

      <!-- Subject -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Subject</mat-label>
        <input 
          matInput 
          [(ngModel)]="subject" 
          placeholder="Enter email subject"
          [disabled]="sending()"
          required>
        <mat-icon matPrefix>subject</mat-icon>
      </mat-form-field>

      <!-- Message -->
      <mat-form-field appearance="outline" class="full-width message-field" [class.preview-hidden]="previewMode()">
        <mat-label>Message</mat-label>
        <textarea 
          matInput 
          [(ngModel)]="message"
          placeholder="Enter your message here..."
          rows="10"
          [disabled]="sending()"
          required>
        </textarea>
        <mat-icon matPrefix>message</mat-icon>
        <mat-hint>Use {{'{{'}}firstName{{'}}'}} and {{'{{'}}lastName{{'}}'}} for personalization</mat-hint>
      </mat-form-field>

      <!-- Message Preview -->
      <div class="message-preview-container" *ngIf="previewMode()">
        <div class="preview-label">Preview:</div>
        <div class="message-preview" [innerHTML]="getPreviewHtml()"></div>
      </div>

      <!-- Placeholder Buttons -->
      <div class="placeholder-buttons">
        <button 
          mat-stroked-button 
          type="button"
          (click)="insertPlaceholder('{{firstName}}')"
          [disabled]="sending() || previewMode()"
          matTooltip="Insert first name placeholder">
          <mat-icon>person</mat-icon>
          First Name
        </button>
        <button 
          mat-stroked-button 
          type="button"
          (click)="insertPlaceholder('{{lastName}}')"
          [disabled]="sending() || previewMode()"
          matTooltip="Insert last name placeholder">
          <mat-icon>person_outline</mat-icon>
          Last Name
        </button>
        <button 
          mat-stroked-button 
          type="button"
          (click)="togglePreview()"
          [disabled]="sending()"
          [color]="previewMode() ? 'accent' : ''">
          <mat-icon>{{ previewMode() ? 'edit' : 'visibility' }}</mat-icon>
          {{ previewMode() ? 'Edit' : 'Preview' }}
        </button>
      </div>

      <!-- Options -->
      <div class="options-section">
        <mat-checkbox 
          [(ngModel)]="personalize"
          [disabled]="sending()">
          Personalize emails (use name placeholders)
        </mat-checkbox>

        <mat-checkbox *ngIf="isSendToAll"
          [(ngModel)]="includeHidden"
          [disabled]="sending()">
          Include hidden members
        </mat-checkbox>
      </div>

      <!-- Error Message -->
      <div class="error-message" *ngIf="error()">
        <mat-icon>error</mat-icon>
        <span>{{ error() }}</span>
      </div>

      <!-- Sending Indicator -->
      <div class="sending-indicator" *ngIf="sending()">
        <mat-spinner diameter="24"></mat-spinner>
        <span>Sending emails...</span>
      </div>
    </div>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button 
      mat-button 
      (click)="cancel()"
      [disabled]="sending()">
      Cancel
    </button>
    <button 
      mat-raised-button 
      color="primary"
      (click)="sendEmail()"
      [disabled]="!isValid || sending()">
      <mat-icon>send</mat-icon>
      Send Email
    </button>
  </mat-dialog-actions>
</div>
