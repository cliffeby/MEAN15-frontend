<form [formGroup]="matchForm" (ngSubmit)="submit()" class="match-form">
  <h2>Create New Match</h2>

  <mat-form-field appearance="fill">
    <mat-label>Match Name</mat-label>
    <input matInput formControlName="name" required placeholder="Enter match name" title="Match Name" />
    <mat-error *ngIf="matchForm.get('name')?.hasError('required')">
      Match name is required
    </mat-error>
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Scorecard</mat-label>
    <mat-select formControlName="scorecardId" placeholder="Select a scorecard" (selectionChange)="onScorecardChange($event.value)">
      <mat-option value="">None</mat-option>
      <mat-option *ngFor="let scorecard of scorecards" [value]="scorecard._id">
        {{ scorecard.name || scorecard.groupName || 'Unnamed Scorecard' }}
        <span *ngIf="scorecard.rating"> - Rating: {{ scorecard.rating }}</span>
        <span *ngIf="scorecard.slope"> - Slope: {{ scorecard.slope }}</span>
      </mat-option>
    </mat-select>
    <mat-error *ngIf="matchForm.get('scorecardId')?.hasError('required')">
      Scorecard selection is required
    </mat-error>
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Course/Group Name</mat-label>
    <input matInput formControlName="scGroupName" placeholder="Enter course or group name" title="Course Name" />
  </mat-form-field>

  <mat-form-field appearance="fill">
    <mat-label>Status</mat-label>
    <mat-select formControlName="status" required>
      <mat-option *ngFor="let status of statusOptions" [value]="status.value">
        {{ status.label }}
      </mat-option>
    </mat-select>
    <mat-error *ngIf="matchForm.get('status')?.hasError('required')">
      Status is required
    </mat-error>
  </mat-form-field>

  <!-- Member Lineup Section -->
  <div class="lineup-section">
    <div class="lineup-header">
      <h3>Match Lineup</h3>
      <button mat-raised-button color="accent" type="button" (click)="openMemberSelectionDialog()" class="select-members-btn">
        <mat-icon>group_add</mat-icon>
        Select Members
      </button>
    </div>

    <!-- Current Lineup Display -->
    <div class="current-lineup" formArrayName="lineUps">
      <h4>Current Lineup ({{ lineUpsArray.length }} members)</h4>
      <p *ngIf="lineUpsArray.length === 0" class="no-members">No members added to lineup yet</p>
      <ng-container *ngIf="members$ | async as members">
        <div *ngIf="lineUpsArray.length > 0" class="lineup-compact">
          <ng-container *ngFor="let memberControl of lineUpsArray.controls; let i = index">
            <div *ngIf="i % 4 === 0" class="member-group">
              <div class="member-group-box">
                <span class="member-names">
                  <ng-container *ngFor="let j of [0,1,2,3]; let isLast = last">
                    <ng-container *ngIf="lineUpsArray.controls[i + j] as control">
                      <ng-container *ngIf="getMemberById(control.value, members) as member; else showId">
                        {{ getCompactName(member) }}
                      </ng-container>
                      <ng-template #showId>{{ control.value }}</ng-template>
                      <span *ngIf="!isLast && lineUpsArray.controls[i + j + 1]"> : </span>
                    </ng-container>
                  </ng-container>
                </span>
                <button mat-icon-button type="button" color="warn" (click)="removeGroup(i)" class="group-remove-btn">
                  <span>Ã—</span>
                </button>
              </div>
            </div>
          </ng-container>
        </div>
      </ng-container>
    </div>
  </div>

  <mat-form-field appearance="fill">
    <mat-label>Date Played</mat-label>
    <input matInput [matDatepicker]="picker" formControlName="datePlayed" placeholder="Select date played" title="Date Played" />
    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
    <mat-datepicker #picker></mat-datepicker>
    <mat-error *ngIf="matchForm.get('datePlayed')?.hasError('required')">
      Date played is required
    </mat-error>
  </mat-form-field>

  <!-- User field is hidden and automatically set to current user -->

  <button mat-raised-button color="primary" type="submit" [disabled]="(loading$ | async) || matchForm.invalid">
    {{ (loading$ | async) ? 'Creating...' : 'Create Match' }}
  </button>
</form>